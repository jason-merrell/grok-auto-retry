name: Build and Draft Release

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches:
            - main
    workflow_dispatch:
        inputs:
            version_bump:
                description: "Version bump type"
                required: true
                default: "minor"
                type: choice
                options:
                    - major
                    - minor
                    - patch

permissions:
    contents: write
    pull-requests: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for changelog generation

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: extension/package-lock.json

            - name: Install dependencies
              run: |
                  cd extension
                  npm ci

            - name: Build extension
              run: |
                  cd extension
                  npm run build

            - name: Get current version
              id: current_version
              run: |
                  VERSION=$(node -p "require('./extension/package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Current version: $VERSION"

            - name: Bump version
              id: bump_version
              run: |
                  CURRENT="${{ steps.current_version.outputs.version }}"
                  IFS='.' read -r -a parts <<< "$CURRENT"
                  MAJOR="${parts[0]}"
                  MINOR="${parts[1]}"
                  PATCH="${parts[2]}"

                  # Determine bump type (manual trigger or default to minor for PRs)
                  BUMP_TYPE="${{ github.event.inputs.version_bump || 'minor' }}"

                  if [ "$BUMP_TYPE" = "major" ]; then
                    NEW_VERSION="$((MAJOR + 1)).0.0"
                  elif [ "$BUMP_TYPE" = "minor" ]; then
                    NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                  else
                    NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                  fi

                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
                  echo "Bumped version ($BUMP_TYPE): $CURRENT -> $NEW_VERSION"

                  # Update package.json
                  cd extension
                  npm version $NEW_VERSION --no-git-tag-version

                  # Update manifest.json
                  jq --arg version "$NEW_VERSION" '.version = $version' public/manifest.json > public/manifest.json.tmp
                  mv public/manifest.json.tmp public/manifest.json

            - name: Get last release tag
              id: last_release
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      try {
                        const { data: releases } = await github.rest.repos.listReleases({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          per_page: 1
                        });
                        
                        if (releases.length > 0) {
                          const lastTag = releases[0].tag_name;
                          core.setOutput('tag', lastTag);
                          console.log(`Last release tag: ${lastTag}`);
                          return lastTag;
                        }
                      } catch (error) {
                        console.log('No previous releases found');
                      }

                      core.setOutput('tag', '');
                      return '';

            - name: Generate changelog with Copilot
              id: changelog
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      let commitMessages = '';
                      let prInfo = '';
                      const lastTag = '${{ steps.last_release.outputs.tag }}';

                      // If triggered by PR, get PR commits and details
                      if (context.payload.pull_request) {
                        const { data: commits } = await github.rest.pulls.listCommits({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: context.payload.pull_request.number
                        });
                        
                        commitMessages = commits.map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n');
                        
                        const { data: pr } = await github.rest.pulls.get({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: context.payload.pull_request.number
                        });
                        
                        prInfo = `**PR #${pr.number}: ${pr.title}**\n\n### Description\n${pr.body || 'No description provided.'}\n\n`;
                      } 
                      // If manual trigger, get commits since last release
                      else {
                        const compareBase = lastTag || 'HEAD~10'; // Last release or last 10 commits
                        
                        const { data: comparison } = await github.rest.repos.compareCommits({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          base: compareBase,
                          head: context.sha
                        });
                        
                        commitMessages = comparison.commits
                          .map(c => `- ${c.commit.message.split('\n')[0]}`)
                          .join('\n');
                      }

                      // Generate changelog content
                      const compareUrl = lastTag 
                        ? `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${lastTag}...v${{ steps.bump_version.outputs.new_version }}`
                        : `https://github.com/${context.repo.owner}/${context.repo.repo}/commits/v${{ steps.bump_version.outputs.new_version }}`;

                      const changelog = `## What's Changed in v${{ steps.bump_version.outputs.new_version }}

                      ${prInfo}### Changes
                      ${commitMessages}

                      **Full Changelog**: ${compareUrl}`;

                      core.setOutput('changelog', changelog);

                      return changelog;

            - name: Create dist archive
              run: |
                  cd extension/dist
                  zip -r ../../grok-retry-extension-v${{ steps.bump_version.outputs.new_version }}.zip .
                  cd ../..
                  echo "Created: grok-retry-extension-v${{ steps.bump_version.outputs.new_version }}.zip"
                  ls -lh *.zip

            - name: Create draft release
              uses: softprops/action-gh-release@v1
              with:
                  name: "v${{ steps.bump_version.outputs.new_version }}"
                  tag_name: "v${{ steps.bump_version.outputs.new_version }}"
                  body: ${{ steps.changelog.outputs.changelog }}
                  draft: true
                  prerelease: false
                  files: |
                      grok-retry-extension-v${{ steps.bump_version.outputs.new_version }}.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

            - name: Comment on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const changelog = `${{ steps.changelog.outputs.changelog }}`;

                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        body: `## ðŸš€ Draft Release Created

                      A draft release has been created for version **v${{ steps.bump_version.outputs.new_version }}** (${`${{ steps.bump_version.outputs.bump_type }}`} bump)

                      ${changelog}

                      ### Next Steps
                      1. Review the draft release [here](https://github.com/${context.repo.owner}/${context.repo.repo}/releases)
                      2. Make any necessary edits to the changelog
                      3. Publish the release when ready

                      ðŸ“¦ The extension zip file is attached to the draft release.`
                      });

            - name: Summary for manual trigger
              if: github.event_name == 'workflow_dispatch'
              run: |
                  echo "## ðŸš€ Draft Release Created" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Version**: v${{ steps.bump_version.outputs.new_version }} (${{ steps.bump_version.outputs.bump_type }} bump)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
                  echo "1. Review the draft release [here](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
                  echo "2. Make any necessary edits to the changelog" >> $GITHUB_STEP_SUMMARY
                  echo "3. Publish the release when ready" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“¦ The extension zip file is attached to the draft release." >> $GITHUB_STEP_SUMMARY

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: extension-build-v${{ steps.bump_version.outputs.new_version }}
                  path: |
                      extension/dist/**/*
                      grok-retry-extension-v${{ steps.bump_version.outputs.new_version }}.zip
                  retention-days: 30
